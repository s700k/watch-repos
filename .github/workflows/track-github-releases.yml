name: Track GitHub Releases
on:
  schedule:
    - cron: "0 */3 * * *"  # æ¯3å°æ—¶æ£€æŸ¥ä¸€æ¬¡â€Œ:ml-citation{ref="2" data="citationList"}

jobs:
  check-releases:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥ç›®æ ‡ä»“åº“Releasesæ›´æ–°
        env:
          REPO_LIST: "acidanthera/OpenCorePkg s700k/lms-material"  # ç›‘æŽ§ä»“åº“åˆ—è¡¨ï¼Œç©ºæ ¼åˆ†éš”â€Œ:ml-citation{ref="2" data="citationList"}
          BARK_KEY: ${{ secrets.BARK_KEY }}          # Barkè®¾å¤‡å¯†é’¥â€Œ:ml-citation{ref="1" data="citationList"}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}          # GitHub APIè®¤è¯ä»¤ç‰Œâ€Œ:ml-citation{ref="2" data="citationList"}
        run: |
          for repo in $REPO_LIST; do
            # èŽ·å–æœ€æ–°Releaseæ•°æ®
            RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/$repo/releases/latest" || echo "{}")
            
            LATEST_TAG=$(echo "$RELEASE_JSON" | jq -r .tag_name)
            RELEASE_NAME=$(echo "$RELEASE_JSON" | jq -r .name | tr -d '\n' | cut -c 1-50)
            RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r .body | head -n 1 | tr -d '\n' | sed 's/"/\\"/g')

            CACHE_FILE=".release_cache_${repo//\//_}.txt"

            # å˜æ›´æ£€æµ‹ä¸ŽæŽ¨é€
            if [ -f $CACHE_FILE ]; then
              CACHED_TAG=$(cat $CACHE_FILE)
              if [ "$LATEST_TAG" != "$CACHED_TAG" ] && [ "$LATEST_TAG" != "null" ]; then
                curl -X POST "https://bark.fzstudio.top/$BARK_KEY" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "title": "ðŸš€æ–°ç‰ˆæœ¬å‘å¸ƒ: '"$repo@$LATEST_TAG"'",
                    "body": "ç‰ˆæœ¬: '"$RELEASE_NAME"'\næ‘˜è¦: '"$RELEASE_BODY"'",
                    "url": "https://github.com/$repo/releases/tag/$LATEST_TAG",
                    "group": "github_releases",
                    "sound": "alarm"
                  }'
                echo $LATEST_TAG > $CACHE_FILE
              fi
            else
              echo $LATEST_TAG > $CACHE_FILE
            fi
          done
